---
interface Props {
  label?: string;
}

const { label } = Astro.props;
---

<div class="relative flex items-center gap-4 py-2" data-divider-root>
  <div class="invisible opacity-0 accent-line" data-divider-line></div>
  {
    label && (
      <span class="invisible opacity-0 eyebrow shrink-0 text-paper-200" data-divider-label>{label}</span>
    )
  }
</div>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const runDividerAnimations = () => {
    const roots = gsap.utils.toArray<HTMLElement>("[data-divider-root]");

    ScrollTrigger.getAll().forEach((trigger) => {
      const id = trigger.vars.id;
      if (typeof id === "string" && id.startsWith("divider-")) {
        trigger.kill();
      }
    });

    if (!roots.length) {
      return;
    }

    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
      gsap.set("[data-divider-line], [data-divider-label]", { autoAlpha: 1 });
      return;
    }

    roots.forEach((root, index) => {
      const line = root.querySelector("[data-divider-line]");
      const label = root.querySelector("[data-divider-label]");

      const timeline = gsap.timeline({
        scrollTrigger: {
          id: `divider-${index}`,
          trigger: root,
          start: "top 90%",
          once: true,
        },
      });

      if (line) {
        timeline.fromTo(
          line,
          {
            autoAlpha: 0,
            scaleX: 0,
            transformOrigin: "left center",
          },
          {
            autoAlpha: 1,
            scaleX: 1,
            duration: 0.36,
            ease: "power2.out",
          },
        );
      }

      if (label) {
        timeline.fromTo(
          label,
          {
            y: 8,
            autoAlpha: 0,
          },
          {
            y: 0,
            autoAlpha: 1,
            duration: 0.26,
            ease: "power2.out",
          },
          0.08,
        );
      }
    });

    ScrollTrigger.refresh();
  };

  const beforeSwapDividerAnimations = () => {
    ScrollTrigger.getAll().forEach((trigger) => {
      const id = trigger.vars.id;
      if (typeof id === "string" && id.startsWith("divider-")) {
        trigger.kill();
      }
    });
  };

  if (document.documentElement.dataset.dividerListenerBound !== "1") {
    document.addEventListener("astro:page-load", runDividerAnimations);
    document.addEventListener("astro:before-swap", beforeSwapDividerAnimations);
    document.documentElement.dataset.dividerListenerBound = "1";
  }
</script>
