---
import { ClientRouter } from "astro:transitions";
import { cn } from "../../lib/utils";
import { normalizePath } from "../../lib/path";
import "../../styles/global.css";

interface Props {
    title?: string;
    description?: string;
}

const { title, description } = Astro.props;

const navItems = [
    { label: "Home", href: "/" },
    { label: "Work", href: "/work" },
    { label: "Resume", href: "/resume" },
    { label: "Contact", href: "/contact" },
];
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>
            {
                `${title ? title : "Shayan Fareed"} | Full Stack JavaScript Developer`
            }
        </title>
        <meta
            name="description"
            content={description
                ? description
                : "Portfolio of Shayan Fareed, Full Stack JavaScript Developer building scalable web applications."}
        />
        <meta name="generator" content={Astro.generator} />
        <ClientRouter fallback="animate" />
    </head>
    <body
        class="min-h-dvh font-body text-paper-50 bg-ink-950 bg-grid"
        data-layout-shell
    >
        <header class="border-b-4 border-paper-50 bg-ink-950">
            <div
                class="container mx-auto p-4 flex flex-wrap gap-3 items-center justify-between"
            >
                <a
                    href="/"
                    class="font-display uppercase tracking-wider text-3xl"
                >
                    SFX//Develops
                </a>
                <nav>
                    <ul class="flex flex-wrap gap-2 items-center">
                        {
                            navItems.map((item) => {
                                const currPath = normalizePath(
                                    Astro.url.pathname,
                                );
                                const itemPath = normalizePath(item.href);
                                const itemIsActive =
                                    itemPath === "/"
                                        ? currPath === "/"
                                        : currPath.startsWith(itemPath);

                                return (
                                    <li>
                                        <a
                                            href={item.href}
                                            class={cn(
                                                "border-2 border-paper-50 py-2 px-3 font-mono uppercase tracking-wider text-xs  transition duration-300 ease-out hover:text-ink-950 hover:bg-paper-50",
                                                !itemIsActive && "",
                                                itemIsActive &&
                                                    "border-acid-300 text-ink-950 bg-acid-300",
                                            )}
                                        >
                                            {item.label}
                                        </a>
                                    </li>
                                );
                            })
                        }
                    </ul>
                </nav>
            </div>
        </header>
        <slot />
        <footer class="border-t-4 border-paper-50 bg-ink-950">
            <div
                class="container mx-auto p-4 flex flex-wrap gap-3 items-center justify-between"
            >
                <p
                    class="invisible opacity-0 font-mono uppercase tracking-wider text-xs text-paper-200"
                    data-layout-footer-text
                >
                    2026 SFX//Develops
                </p>
                <p
                    class="invisible opacity-0 font-mono uppercase tracking-wider text-xs text-acid-100"
                    data-layout-footer-text
                >
                    Built with Astro + Tailwind
                </p>
            </div>
        </footer>
    </body>
</html>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);
    const EASE = "power2.out";

    const runLayoutAnimation = () => {
        const root = document.querySelector("[data-layout-shell]");
        const footer = root?.querySelector("footer");

        if (!root || !footer) {
            return;
        }

        ScrollTrigger.getAll().forEach((trigger) => {
            const id = trigger.vars.id;
            if (typeof id === "string" && id.startsWith("layout-")) {
                trigger.kill();
            }
        });

        gsap.fromTo(
            root.querySelectorAll("[data-layout-footer-text]"),
            { autoAlpha: 0, y: 12 },
            {
                autoAlpha: 1,
                y: 0,
                duration: 0.26,
                stagger: 0.05,
                ease: EASE,
                scrollTrigger: {
                    id: "layout-footer",
                    trigger: footer,
                    start: "top 95%",
                    once: true,
                },
            },
        );

        ScrollTrigger.refresh();
    };

    const beforeSwapLayoutAnimation = () => {
        ScrollTrigger.getAll().forEach((trigger) => {
            const id = trigger.vars.id;
            if (typeof id === "string" && id.startsWith("layout-")) {
                trigger.kill();
            }
        });
    };

    if (document.documentElement.dataset.layoutListenerBound !== "1") {
        document.addEventListener("astro:page-load", runLayoutAnimation);
        document.addEventListener("astro:before-swap", beforeSwapLayoutAnimation);
        document.documentElement.dataset.layoutListenerBound = "1";
    }
</script>
