---
import SectionTitle from "../../components/blocks/section-title.astro";
import RootLayout from "../../components/layouts/root-layout.astro";
import Divider from "../../components/ui/divider.astro";
import { experience } from "../../data/portfolio";
import { cn } from "../../lib/utils";
---

<RootLayout
	title="Work"
	description="Experience timeline for Shayan Fareed across production full-stack roles and freelance delivery."
>
	<main data-page="work">
		<SectionTitle
			kicker="Experience"
			title="Work History"
			description="Production roles, remote collaboration, and full stack delivery across international teams and freelance clients."
		/>
		<section class="px-4">
			<div class="container mx-auto">
				<Divider label="Timeline" />
			</div>
		</section>
		<section class="p-4 sm:py-12">
			<ul class="space-y-4 container mx-auto">
				{
					experience.map((item, index) => (
						<li
							class="grid gap-4 lg:grid-cols-[14rem_1fr]"
							data-work-item
						>
							<div
								class="invisible opacity-0 space-y-2 border-l-4 border-acid-300 pl-4 lg:border-l-0 lg:border-r-4 lg:pl-0"
								data-work-period
							>
								<p class="font-mono uppercase tracking-widest text-xs">
									{item.startDate} - {item.endDate}
								</p>
								<span class="border-2 border-paper-300 py-1 px-3 font-mono uppercase tracking-widest text-[0.5rem] text-paper-100">
									{item.location}
								</span>
							</div>
							<article
								class="invisible opacity-0 space-y-6 border-4 p-4 transition duration-300 ease-out bg-ink-900 hover:-translate-1 sm:p-6"
								data-work-card
								data-anim-card
							>
								<div
									class={cn(
										"h-2 w-16 bg-acid-300",
										index % 2 === 0 && "bg-safety-500",
									)}
									data-work-bar
									data-anim-accent
								/>
								<div class="space-y-4">
									<div class="space-y-1">
										<h3 class="font-display uppercase tracking-wider text-3xl text-paper-50">
											{item.role}
										</h3>
										<p
											class={cn(
												"font-mono uppercase tracking-widest text-xs text-acid-300",
												index % 2 === 0 &&
													"text-safety-500",
											)}
										>
											{item.company}
										</p>
									</div>
									<ul
										class={cn(
											"space-y-2 pl-4 text-sm list-disc marker:text-acid-300",
											index % 2 === 0 &&
												"marker:text-safety-500",
										)}
									>
										{item.achievements.map((point) => (
											<li
												class="invisible opacity-0"
												data-work-bullet
												data-anim-list-item
											>
												{point}
											</li>
										))}
									</ul>
								</div>
							</article>
						</li>
					))
				}
			</ul>
		</section>
	</main>
</RootLayout>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";

	gsap.registerPlugin(ScrollTrigger);
	const EASE = "power2.out";
	const CARD_FROM = { autoAlpha: 0, y: 24 };
	const CARD_TO = { autoAlpha: 1, y: 0, duration: 0.42, ease: EASE };
	const ITEM_FROM = { autoAlpha: 0, y: 12 };
	const ITEM_TO = { autoAlpha: 1, y: 0, duration: 0.26, ease: EASE };
	const ITEM_STAGGER = 0.05;
	const ACCENT_FROM = { scaleX: 0, transformOrigin: "left center" };
	const ACCENT_TO = { scaleX: 1, duration: 0.28, ease: EASE };

	const runWorkAnimations = () => {
		const root = document.querySelector('[data-page="work"]');

		if (!root) {
			return;
		}

		ScrollTrigger.getAll().forEach((trigger) => {
			const id = trigger.vars.id;
			if (typeof id === "string" && id.startsWith("work-")) {
				trigger.kill();
			}
		});

		gsap.utils
			.toArray<HTMLElement>("[data-work-item]")
			.forEach((row, index) => {
				const dateBlock = row.querySelector("[data-work-period]");
				const card = row.querySelector("[data-anim-card]");
				const accent = row.querySelector("[data-anim-accent]");
				const points = row.querySelectorAll("[data-anim-list-item]");

				const rowTimeline = gsap.timeline({
					scrollTrigger: {
						id: `work-row-${index}`,
						trigger: row,
						start: "top 86%",
						once: true,
					},
				});

				rowTimeline.fromTo(
					dateBlock,
					CARD_FROM,
					{
						...CARD_TO,
						duration: 0.36,
					},
					0,
				);

				rowTimeline.fromTo(
					card,
					CARD_FROM,
					CARD_TO,
					0.06,
				);

				if (accent) {
					rowTimeline.fromTo(
						accent,
						ACCENT_FROM,
						ACCENT_TO,
						0.14,
					);
				}

				if (points.length) {
					gsap.fromTo(
						points,
						ITEM_FROM,
						{
							...ITEM_TO,
							stagger: ITEM_STAGGER,
							scrollTrigger: {
								id: `work-points-${index}`,
								trigger: row,
								start: "top 82%",
								once: true,
							},
						},
					);
				}
			});

		ScrollTrigger.refresh();
	};

	const beforeSwapWorkAnimations = () => {
		ScrollTrigger.getAll().forEach((trigger) => {
			const id = trigger.vars.id;
			if (typeof id === "string" && id.startsWith("work-")) {
				trigger.kill();
			}
		});
	};

	if (document.documentElement.dataset.workListenerBound !== "1") {
		document.addEventListener("astro:page-load", runWorkAnimations);
		document.addEventListener("astro:before-swap", beforeSwapWorkAnimations);
		document.documentElement.dataset.workListenerBound = "1";
	}
</script>
