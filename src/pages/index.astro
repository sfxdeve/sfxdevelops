---
import RootLayout from "../components/layouts/root-layout.astro";
import ButtonLink from "../components/ui/button-link.astro";
import Divider from "../components/ui/divider.astro";
import {
	coreCompetencies,
	featuredExperience,
	profile,
} from "../data/portfolio";
import { cn } from "../lib/utils";
---

<RootLayout>
	<main data-page="home">
		<section class="p-4 sm:py-12">
			<div class="container mx-auto">
				<article
					class="border-4 p-4 grid gap-4 lg:grid-cols-[1.2fr_0.8fr] bg-ink-900 sm:p-6 sm:gap-6"
					data-home-hero-panel
					data-anim-card
				>
					<div class="space-y-5">
						<p
							class="invisible opacity-0 font-mono uppercase tracking-widest text-xs text-acid-300"
							data-home-hero-kicker
						>
							Available for impact first teams
						</p>
						<h3
							class="invisible opacity-0 max-w-2xl font-display uppercase tracking-wider text-5xl sm:text-9xl"
							data-home-hero-title
						>
							{profile.name}
						</h3>
						<div class="flex flex-wrap gap-2">
							<div
								class="invisible opacity-0 border-2 border-paper-300 py-1 px-3 font-mono uppercase tracking-widest text-xs text-paper-100"
								data-home-hero-meta-item
							>
								{profile.title}
							</div>
							<div
								class="invisible opacity-0 border-2 border-paper-300 py-1 px-3 font-mono uppercase tracking-widest text-xs text-paper-100"
								data-home-hero-meta-item
							>
								{profile.location}
							</div>
						</div>
						<div class="space-y-2">
							{
								profile.summary.map((paragraph) => (
									<p
										class="invisible opacity-0 max-w-2xl text-base text-paper-100 sm:text-lg"
										data-home-hero-copy
									>
										{paragraph}
									</p>
								))
							}
							<p
								class="invisible opacity-0 uppercase tracking-widest text-safety-300"
								data-home-hero-copy
							>
								{profile.relocationNote}
							</p>
						</div>
						<ul class="flex flex-wrap gap-3" data-home-hero-actions>
							<li class="invisible opacity-0">
								<ButtonLink href="/work" variant="solid"
									>See Work
								</ButtonLink>
							</li>
							<li class="invisible opacity-0">
								<ButtonLink href="/resume" variant="outline"
									>Open Resume
								</ButtonLink>
							</li>
							<li class="invisible opacity-0">
								<ButtonLink href="/contact" variant="outline"
									>Contact
								</ButtonLink>
							</li>
						</ul>
					</div>
					<div
						class="hidden lg:block space-y-4 border-4 p-4 bg-ink-950 sm:p-6"
					>
						<h3 class="font-mono uppercase tracking-widest text-xs">
							Core competencies
						</h3>
						<ul class="flex flex-wrap gap-2">
							{
								coreCompetencies.map((item) => (
									<li
										class="invisible opacity-0 border-2 border-paper-300 py-1 px-3 font-mono uppercase tracking-widest text-xs text-paper-100"
										data-home-competency
										data-anim-list-item
									>
										{item}
									</li>
								))
							}
						</ul>
					</div>
				</article>
			</div>
		</section>
		<section class="px-4">
			<div class="container mx-auto">
				<Divider label="Featured" />
			</div>
		</section>
		<section class="p-4 sm:py-12">
			<ul class="container mx-auto grid gap-4 md:grid-cols-2">
				{
					featuredExperience.map((item, index) => (
						<li>
							<article
								class="invisible opacity-0 space-y-6 border-4 p-4 transition duration-300 ease-out bg-ink-900 hover:-translate-1 sm:p-6"
								data-home-feature-card
								data-anim-card
							>
								<div
									class={cn(
										"h-2 w-16 bg-acid-300",
										index % 2 === 0 && "bg-safety-500",
									)}
									data-home-feature-accent
									data-anim-accent
								/>
								<div class="space-y-4">
									<div class="space-y-1">
										<h3 class="font-display uppercase tracking-wider text-3xl text-paper-50">
											{item.role}
										</h3>
										<p
											class={cn(
												"font-mono uppercase tracking-widest text-xs text-acid-300",
												index % 2 === 0 &&
													"text-safety-500",
											)}
										>
											{item.company}
										</p>
									</div>
									<ul
										class={cn(
											"space-y-2 pl-4 text-sm list-disc marker:text-acid-300",
											index % 2 === 0 &&
												"marker:text-safety-500",
										)}
									>
										{item.achievements.map((point) => (
											<li
												class="invisible opacity-0"
												data-home-feature-point
												data-anim-list-item
											>
												{point}
											</li>
										))}
									</ul>
								</div>
							</article>
						</li>
					))
				}
			</ul>
		</section>
	</main>
</RootLayout>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";
	import { SplitText } from "gsap/SplitText";

	gsap.registerPlugin(ScrollTrigger, SplitText);
	const EASE = "power2.out";
	const CARD_FROM = { autoAlpha: 0, y: 24 };
	const CARD_TO = { autoAlpha: 1, y: 0, duration: 0.42, ease: EASE };
	const ITEM_FROM = { autoAlpha: 0, y: 12 };
	const ITEM_TO = { autoAlpha: 1, y: 0, duration: 0.26, ease: EASE };
	const ITEM_STAGGER = 0.05;
	const ACCENT_FROM = { scaleX: 0, transformOrigin: "left center" };
	const ACCENT_TO = { scaleX: 1, duration: 0.28, ease: EASE };

	let homeHeroTitleSplit: SplitText | null = null;

	const resetHomeSplit = () => {
		if (homeHeroTitleSplit) {
			homeHeroTitleSplit.revert();
			homeHeroTitleSplit = null;
		}
	};

	const runHomeAnimations = () => {
		const root = document.querySelector('[data-page="home"]');

		if (!root) {
			return;
		}

		if (homeHeroTitleSplit) {
			homeHeroTitleSplit.revert();
			homeHeroTitleSplit = null;
		}

		ScrollTrigger.getAll().forEach((trigger) => {
			const id = trigger.vars.id;
			if (typeof id === "string" && id.startsWith("home-")) {
				trigger.kill();
			}
		});

		const heroPanel = root.querySelector("[data-home-hero-panel]");

		const heroTitle = root.querySelector<HTMLElement>(
			"[data-home-hero-title]",
		);
		if (heroTitle) {
			gsap.set(heroTitle, { autoAlpha: 1 });
			homeHeroTitleSplit = SplitText.create(heroTitle, {
				type: "words,chars",
			});
		}

		if (homeHeroTitleSplit && heroPanel) {
			const heroTimeline = gsap.timeline({
				scrollTrigger: {
					id: "home-hero",
					trigger: heroPanel,
					start: "top 88%",
					once: true,
				},
			});

			heroTimeline.fromTo(
				homeHeroTitleSplit.chars,
				{ autoAlpha: 0, y: 16 },
				{
					autoAlpha: 1,
					y: 0,
					duration: 0.34,
					stagger: 0.02,
					ease: EASE,
				},
				0,
			);

			heroTimeline.fromTo(
				root.querySelectorAll(
					"[data-home-hero-kicker], [data-home-hero-meta-item], [data-home-hero-copy], [data-home-hero-actions] li",
				),
				ITEM_FROM,
				{
					...ITEM_TO,
					stagger: ITEM_STAGGER,
				},
				0.08,
			);
		}

		const competencyChips = gsap.utils.toArray<HTMLElement>(
			"[data-home-competency]",
		);
		competencyChips.forEach((chip, index) => {
			gsap.fromTo(
				chip,
				ITEM_FROM,
				{
					...ITEM_TO,
					duration: 0.24,
					scrollTrigger: {
						id: `home-competency-${index}`,
						trigger: chip,
						start: "top 90%",
						once: true,
					},
				},
			);
		});

		gsap.utils
			.toArray<HTMLElement>("[data-home-feature-card]")
			.forEach((card, index) => {
				const accent = card.querySelector("[data-anim-accent]");
				const points = card.querySelectorAll("[data-anim-list-item]");

				gsap.fromTo(
					card,
					CARD_FROM,
					{
						...CARD_TO,
						scrollTrigger: {
							id: `home-feature-card-${index}`,
							trigger: card,
							start: "top 86%",
							once: true,
						},
					},
				);

				if (accent) {
					gsap.fromTo(
						accent,
						ACCENT_FROM,
						{
							...ACCENT_TO,
							scrollTrigger: {
								id: `home-feature-accent-${index}`,
								trigger: card,
								start: "top 86%",
								once: true,
							},
						},
					);
				}

				if (points.length) {
					gsap.fromTo(
						points,
						ITEM_FROM,
						{
							...ITEM_TO,
							stagger: ITEM_STAGGER,
							scrollTrigger: {
								id: `home-feature-points-${index}`,
								trigger: card,
								start: "top 82%",
								once: true,
							},
						},
					);
				}
			});

		ScrollTrigger.refresh();
	};

	const beforeSwapHomeAnimations = () => {
		resetHomeSplit();
		ScrollTrigger.getAll().forEach((trigger) => {
			const id = trigger.vars.id;
			if (typeof id === "string" && id.startsWith("home-")) {
				trigger.kill();
			}
		});
	};

	if (document.documentElement.dataset.homeListenerBound !== "1") {
		document.addEventListener("astro:page-load", runHomeAnimations);
		document.addEventListener("astro:before-swap", beforeSwapHomeAnimations);
		document.documentElement.dataset.homeListenerBound = "1";
	}
</script>
