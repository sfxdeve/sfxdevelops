---
import RootLayout from "../components/layouts/root-layout.astro";
import ButtonLink from "../components/ui/button-link.astro";
import Divider from "../components/ui/divider.astro";
import { featuredExperience, profile } from "../data/portfolio";

const trustSignals = [
  { label: "Experience", value: "3+ years" },
  { label: "Core stack", value: "React + Node" },
  { label: "Delivery", value: "Remote / Async" },
  { label: "Availability", value: "Open now" },
];
---

<RootLayout
  title="Full Stack Engineer Portfolio"
  description="Portfolio of Shayan Fareed featuring full stack JavaScript delivery, case studies, and technical capabilities."
>
  <main data-page="home" class="px-4 pb-12 pt-12 sm:pt-16">
    <section class="mx-auto w-full max-w-6xl" data-home-hero>
      <article class="surface rounded-xl p-7 sm:p-10" data-home-hero-panel>
        <p class="eyebrow" data-home-hero-kicker>{profile.title}</p>
        <h1
          class="mt-4 max-w-4xl font-display text-4xl font-bold leading-[0.98] text-paper-50 sm:text-6xl lg:text-7xl"
          data-home-hero-title
        >
          Shipping full stack products that stay easy to evolve.
        </h1>
        <p
          class="mt-5 max-w-3xl text-base text-paper-100 sm:text-lg"
          data-home-hero-copy
        >
          I design and ship full stack JavaScript systems that stay maintainable
          as teams and product scope grow.
        </p>
        <p class="mt-3 text-sm text-paper-200" data-home-hero-copy>
          Based in {profile.location}. {profile.relocationNote}
        </p>

        <ul class="mt-8 flex flex-wrap gap-3" data-home-hero-actions>
          <li>
            <ButtonLink href="/work" variant="primary">View Work</ButtonLink>
          </li>
          <li>
            <ButtonLink href="/resume" variant="secondary"
              >View Resume</ButtonLink
            >
          </li>
        </ul>
      </article>
    </section>

    <section class="mx-auto mt-8 w-full max-w-6xl">
      <ul
        class="grid gap-3 border-y border-paper-200/15 py-4 sm:grid-cols-2 lg:grid-cols-4"
      >
        {
          trustSignals.map((signal) => (
            <li data-home-stat>
              <p class="eyebrow text-paper-300">{signal.label}</p>
              <p class="mt-1 text-sm text-paper-100">{signal.value}</p>
            </li>
          ))
        }
      </ul>
    </section>

    <section class="mx-auto mt-12 w-full max-w-6xl">
      <Divider label="Experience Highlights" />
    </section>

    <section class="mx-auto mt-7 w-full max-w-6xl">
      <ul class="grid gap-4 lg:grid-cols-2">
        {
          featuredExperience.map((item, index) => (
            <li>
              <article
                class="surface-muted rounded-xl p-6"
                data-home-feature-card
              >
                <div
                  class={
                    index % 2 === 0
                      ? "accent-line max-w-28"
                      : "accent-line max-w-28 opacity-80"
                  }
                  data-home-feature-accent
                  data-anim-accent
                />
                <p class="eyebrow mt-4 text-paper-300">
                  {item.startDate} - {item.endDate}
                </p>
                <h2 class="mt-3 font-display text-3xl font-bold leading-tight text-paper-50">
                  {item.role}
                </h2>
                <p class="mt-1 text-sm text-paper-200">
                  {item.company} â€¢ {item.location}
                </p>
                <ul class="mt-4 list-disc space-y-2 pl-5 text-sm text-paper-100 marker:text-paper-300">
                  {item.achievements.map((point) => (
                    <li data-anim-list-item>{point}</li>
                  ))}
                </ul>
              </article>
            </li>
          ))
        }
      </ul>
    </section>
  </main>
</RootLayout>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { SplitText } from "gsap/SplitText";

  gsap.registerPlugin(ScrollTrigger, SplitText);
  const EASE = "power2.out";
  const CARD_FROM = { autoAlpha: 0, y: 24 };
  const CARD_TO = { autoAlpha: 1, y: 0, duration: 0.42, ease: EASE };
  const ITEM_FROM = { autoAlpha: 0, y: 12 };
  const ITEM_TO = { autoAlpha: 1, y: 0, duration: 0.26, ease: EASE };
  const ITEM_STAGGER = 0.05;
  const ACCENT_FROM = { scaleX: 0, transformOrigin: "left center" };
  const ACCENT_TO = { scaleX: 1, duration: 0.28, ease: EASE };

  let homeHeroTitleSplit: SplitText | null = null;

  const resetHomeSplit = () => {
    if (homeHeroTitleSplit) {
      homeHeroTitleSplit.revert();
      homeHeroTitleSplit = null;
    }
  };

  const runHomeAnimations = () => {
    const root = document.querySelector('[data-page="home"]');

    if (!root) {
      return;
    }

    resetHomeSplit();
    ScrollTrigger.getAll().forEach((trigger) => {
      const id = trigger.vars.id;
      if (typeof id === "string" && id.startsWith("home-")) {
        trigger.kill();
      }
    });

    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
      gsap.set(
        "[data-home-hero-title], [data-home-hero-kicker], [data-home-hero-copy], [data-home-hero-actions] li, [data-home-stat], [data-home-feature-card], [data-anim-accent], [data-anim-list-item]",
        {
          clearProps: "all",
          autoAlpha: 1,
        },
      );
      return;
    }

    const heroPanel = root.querySelector("[data-home-hero-panel]");
    const heroTitle = root.querySelector<HTMLElement>("[data-home-hero-title]");

    if (heroTitle) {
      gsap.set(heroTitle, { autoAlpha: 1 });
      homeHeroTitleSplit = SplitText.create(heroTitle, {
        type: "words,chars",
      });
    }

    if (homeHeroTitleSplit && heroPanel) {
      const heroTimeline = gsap.timeline({
        scrollTrigger: {
          id: "home-hero",
          trigger: heroPanel,
          start: "top 88%",
          once: true,
        },
      });

      heroTimeline.fromTo(
        homeHeroTitleSplit.chars,
        { autoAlpha: 0, y: 16 },
        {
          autoAlpha: 1,
          y: 0,
          duration: 0.34,
          stagger: 0.02,
          ease: EASE,
        },
        0,
      );

      heroTimeline.fromTo(
        root.querySelectorAll(
          "[data-home-hero-kicker], [data-home-hero-copy], [data-home-hero-actions] li",
        ),
        ITEM_FROM,
        {
          ...ITEM_TO,
          stagger: ITEM_STAGGER,
        },
        0.08,
      );
    }

    gsap.fromTo(root.querySelectorAll("[data-home-stat]"), ITEM_FROM, {
      ...ITEM_TO,
      stagger: ITEM_STAGGER,
      scrollTrigger: {
        id: "home-stats",
        trigger: "[data-home-stat]",
        start: "top 92%",
        once: true,
      },
    });

    gsap.utils
      .toArray<HTMLElement>("[data-home-feature-card]")
      .forEach((card, index) => {
        const accent = card.querySelector("[data-anim-accent]");
        const points = card.querySelectorAll("[data-anim-list-item]");

        gsap.fromTo(card, CARD_FROM, {
          ...CARD_TO,
          scrollTrigger: {
            id: `home-feature-card-${index}`,
            trigger: card,
            start: "top 86%",
            once: true,
          },
        });

        if (accent) {
          gsap.fromTo(accent, ACCENT_FROM, {
            ...ACCENT_TO,
            scrollTrigger: {
              id: `home-feature-accent-${index}`,
              trigger: card,
              start: "top 86%",
              once: true,
            },
          });
        }

        if (points.length) {
          gsap.fromTo(points, ITEM_FROM, {
            ...ITEM_TO,
            stagger: ITEM_STAGGER,
            scrollTrigger: {
              id: `home-feature-points-${index}`,
              trigger: card,
              start: "top 82%",
              once: true,
            },
          });
        }
      });

    ScrollTrigger.refresh();
  };

  const beforeSwapHomeAnimations = () => {
    resetHomeSplit();
    ScrollTrigger.getAll().forEach((trigger) => {
      const id = trigger.vars.id;
      if (typeof id === "string" && id.startsWith("home-")) {
        trigger.kill();
      }
    });
  };

  if (document.documentElement.dataset.homeListenerBound !== "1") {
    document.addEventListener("astro:page-load", runHomeAnimations);
    document.addEventListener("astro:before-swap", beforeSwapHomeAnimations);
    document.documentElement.dataset.homeListenerBound = "1";
  }
</script>
